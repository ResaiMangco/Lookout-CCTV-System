<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lookout CCTV System</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Poppins:wght@500;600&display=swap">
    <link rel="stylesheet" href="static/css/main.css">
</head>
<body>
    <div class="container">
        <div class="camera-feed">
            <h2>Live Feed</h2>
            <img id="video-stream" 
                src="/video_feed" 
                alt="Camera Feed" >
        </div>

        <div class="controls">
            <h2>Controls</h2>
            <p>Input: Wifi IP:Port </p>
            <input type="text" id="camera-url" placeholder="e.g. 1XX.1XX.X.X:4XX7">
            <input onclick="connectCamera()" type="button" style="background-color: #4CAF50; color: #FFFF;" 
            value="Connect Camera" id="camera">

            <input onclick="startDetection()" type="button" style="background-color: #4CAF50; color: #FFFF;" 
            value="Start Detection" id="detection">
            
            <input onclick="toggleMute()" type="button" style="background-color: #4CAF50; color: #FFFF;" 
            value="Mute" id="mute">


        </div>
        <audio id="alert" src="/static/assets/audios/alarm.mp3" loop></audio>

    </div>
    <div class="output-box">    
    <textarea id="output" readonly placeholder="System messages will appear here..."></textarea>
    </div>


    
    <script>
        const audio = document.getElementById("alert");
        const mute_button = document.getElementById("mute");
        function connectCamera() {
            var elem = document.getElementById("camera")
            if (elem.value == "Connect Camera"){
                writeOutput("Connecting Camera...")
                let  url = document.getElementById('camera-url').value;
                url = "http://" + url + "/video";
                fetch(`/connect_camera?url=${encodeURIComponent(url)}`)
                    .then(res => res.json())
                    .then(data => {
                        writeOutput(data.message)
                        if (data.message != "Invalid camera URL!"){
                            elem.value = "Disconnect Camera";
                            elem.style = "background-color: #a80404; color: #FFFF;";
                        }
                    });
            }
            else{ //disconnectCamera()
                writeOutput("Disconnecting Camera...")
                // Stop detection first if diconnecting camera
                var detect_btn = document.getElementById("detection")
                if (detect_btn.value == "Stop Detection") {
                    writeOutput("Stopping Detection...")
                    detect_btn.value = "Start Detection";
                    detect_btn.style = "background-color: #4CAF50; color: #FFFF;";
                    fetch('/stop_detection')
                        .then(res => res.json())
                        .then(data => writeOutput(data.message));
                }
                if (alarm_on){
                    audio.pause();
                    audio.currentTime = 0;
                    alarm_on = false;
                }

                elem.value = "Connect Camera"
                elem.style = "background-color: #4CAF50; color: #FFFF;";
                fetch('/disconnect_camera')
                .then(res => res.json())
                .then(data => writeOutput(data.message));
            }
            
        }

        function startDetection() {
            var elem = document.getElementById("detection")          
            if (elem.value == "Start Detection"){
                // Auto unmute when detecting
                audio.muted = false
                mute_button.value = "Mute";
                mute_button.style.backgroundColor = "#4CAF50"; // green
                
                writeOutput("Starting Detection...")
                fetch('/start_detection')
                    .then(res => res.json())
                    .then(data => {
                        writeOutput(data.message)
                        if (data.message != "No camera connected!"){
                                elem.value = "Stop Detection";
                                elem.style = "background-color: #a80404; color: #FFFF;";
                        }
                });
            }
            else{ // stopDetection()
                writeOutput("Stopping Detection...")
                if (alarm_on){
                    audio.pause();
                    audio.currentTime = 0;
                    alarm_on = false;
                }
                elem.value = "Start Detection"
                elem.style = "background-color: #4CAF50; color: #FFFF;";
                fetch('/stop_detection')
                .then(res => res.json())
                .then(data => writeOutput(data.message));
            }
        }

        let alarm_on = false
        function updateDetectionStatus() { 
            fetch("/detection_status")
                .then(res => res.json())
                .then(data => {

                    if (data.detected){ 
                        writeOutput("Person Detected")
                        if (!alarm_on) {
                            audio.volume = 1;
                            audio.play();
                            alarm_on = true;
                            writeOutput("Playing Alarm")
                        }
                    } else{
                        if (alarm_on) {
                            audio.pause();
                            audio.currentTime = 0;
                            alarm_on = false;
                        }
                    }
                })
        }
        // Update every 3 sec
        setInterval(updateDetectionStatus, 3000);
        
        
        function toggleMute() {
            
            audio.muted = !audio.muted; 
            if (audio.muted) {
                mute_button.value = "Unmute";                // change text
                mute_button.style.backgroundColor = "#a80404"; // red
            } else {
                mute_button.value = "Mute";
                mute_button.style.backgroundColor = "#4CAF50"; // green
            }
        }

        
        function writeOutput(message) {
            var output = document.getElementById('output');   
            if (output.value === "") {
                lines = []
            } else{
                lines = output.value.split("\n");
            }

            // Timestamp
            const now = new Date();
            const timestamp = now.toLocaleString();

            // Build new message
            const full_message = `[${timestamp}] ${message}`;

            // Prepend
            lines.unshift(full_message);
            sendLogToServer(full_message)

            if (lines.length > 120) {
                lines = lines.slice(0, 100);
            }


            output.value = lines.join("\n");
            output.scrollTop = 0;
        }

        function sendLogToServer(message) {
        fetch("/append_log", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ line : message })
        });
        }

    </script>
</body>

</html>
