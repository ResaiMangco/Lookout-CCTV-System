<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lookout CCTV System</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Poppins:wght@500;600&display=swap">
    <link rel="stylesheet" href="static/css/main.css">
</head>
<body>
    <div class="container">
        <div class="camera-feed">
            <h2>Live Feed</h2>
            <img id="video-stream" 
                src="/video_feed" 
                alt="Camera Feed" >
        </div>

        <div class="controls">
            <h2>Controls</h2>
            <p>Input: Wifi IP:Port </p>
            <input type="text" id="camera-url" placeholder="e.g. 1XX.1XX.X.X:4XX7">
            <button onclick="connectCamera()">Connect Camera</button>
            <button onclick="disconnectCamera()">Disconnect Camera</button>
            <button onclick="startDetection()">Start Detection</button>
            <button onclick="stopDetection()">Stop Detection</button>
        </div>
    </div>
    <div class="output-box">    
    <textarea id="output" readonly placeholder="System messages will appear here..."></textarea>
    </div>


    
    <script>
        function connectCamera() {
            writeOutput("Connecting Camera...")
            let  url = document.getElementById('camera-url').value;
            url = "http://" + url + "/video";
            fetch(`/connect_camera?url=${encodeURIComponent(url)}`)
                .then(res => res.json())
                .then(data => writeOutput(data.message));
            
        }

        function startDetection() {
            writeOutput("Starting Detection...")
            fetch('/start_detection')
                .then(res => res.json())
                .then(data => writeOutput(data.message));
        }

        function stopDetection() {
            writeOutput("Stopping Detection...")
            fetch('/stop_detection')
                .then(res => res.json())
                .then(data => writeOutput(data.message));
        }

        function disconnectCamera() {
            writeOutput("Disconnecting Camera...")
            fetch('/disconnect_camera')
                .then(res => res.json())
                .then(data => writeOutput(data.message));
        }
        function updateDetectionStatus() {
            fetch("/detection_status")
                .then(res => res.json())
                .then(data => {
                    if (data.detected){ writeOutput("Person Detected")}
                })
        }
        // Update every 500ms
        setInterval(updateDetectionStatus, 2000);

        function writeOutput(message) {
            const output = document.getElementById('output');   
            if (output.value === "") {
                lines = []
            } else{
                lines = output.value.split("\n");
            }

            // Timestamp
            const now = new Date();
            const timestamp = now.toLocaleString();

            // Build new message
            const full_message = `[${timestamp}] ${message}`;

            // Prepend
            lines.unshift(full_message);

            if (lines.length > 120) {
                lines = lines.slice(0, 100);
            }


            output.value = lines.join("\n");
            output.scrollTop = 0;
        }
        

    </script>
</body>

</html>